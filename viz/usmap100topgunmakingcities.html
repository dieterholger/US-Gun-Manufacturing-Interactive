<!DOCTYPE html>
<html>

<head>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.7.1/d3-tip.js'></script>
  <meta charset='utf-8'>
  <meta name="viewport" content='width=device-width, initial-scale=1.0'>
  <title></title>
  <style>
    #map {
      width: 100%;
      padding: 10px;
      margin-left: auto;
      margin-right: auto;
    }

    .d3-tip {
      line-height: 1;
      padding: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      border-radius: 10px;
    }

    .clicked {
      fill: rgba(108, 122, 137, 0.5);
    }

    .legend circle {
      fill: none;
      stroke: #ccc;
    }

    .legend text {
      fill: #777;
      font: 10px sans-serif;
      text-anchor: middle;
    }
  </style>
  <script>
    function draw(geo_data) {

      var width = 960,
        height = 500

      var svg = d3.select('#map')
        .append('svg')
        .attr('width', width)
        .attr('height', height)
        .call(responsivefy)
        .append('g');

      var formatComma = d3.format(",");

      var projection = d3.geoAlbersUsa();

      var path = d3.geoPath().projection(projection);

      var map = svg.selectAll('path')
        .data(geo_data.features)
        .enter()
        .append('path')
        .attr('d', path)
        .attr('fill', 'white')
        .attr('stroke', 'rgba(0, 0, 0, 1)')
        .attr('stroke-width', 0.5)
        .on('mouseover', function(d) {
          d3.select(this).attr('fill', 'white')
        })
        .on('mouseout', function() {
          if (d3.select(this).classed('clicked')) {
            console.log('is clicked')
            d3.select(this).attr('fill', 'white')
          } else {
            console.log('is not clicked')
            d3.select(this).attr('fill', 'white')
          }
        })
        // Calls click-to-zoom function defined below.
        .on('click', clicked);

      // Settings for tooltip text and content.

      var tip = d3.tip()
        .attr('class', 'd3-tip')
        .offset([-10, 0])
        .html(function(d) {
          return "<p><strong><font size='2rem'>" + d.city + ", " + d.state + "</p></strong></font>" + "<p><font size='2rem'><strong>Guns Manufactured: </strong>" + formatComma(d.guns) + "</p>" +
            "<p><strong>Top Manufacturer:</strong> " + d.manufacturer +
            "</p></font>";
        })

      svg.call(tip);

      // Responseify function found here: https://brendansudol.com/writing/responsive-d3

      function responsivefy(svg) {
        // get container + svg aspect ratio
        var container = d3.select(svg.node().parentNode),
          width = parseInt(svg.style('width')),
          height = parseInt(svg.style('height')),
          aspect = width / height;

        // add viewBox and preserveAspectRatio properties,
        // and call resize so that svg resizes on inital page load
        svg.attr('viewBox', "0 0 " + width + ' ' + height)
          .attr('perserveAspectRatio', 'xMinYMid')
          .call(resize);

        // to register multiple listeners for same event type,
        // you need to add namespace, i.e., 'click.foo'
        // necessary if you call invoke this function for multiple svgs
        // api docs: https://github.com/mbostock/d3/wiki/Selections#on
        d3.select(window).on("resize." + container.attr("id"), resize);

        // get width of container and resize svg to fit it
        function resize() {
          var targetWidth = parseInt(container.style("width"));
          svg.attr("width", targetWidth);
          svg.attr("height", Math.round(targetWidth / aspect));
        }
      }

      // Click-to-zoom function adapted from Mike Bostock's code: https://bl.ocks.org/mbostock/2206590

      function clicked(d) {
        // Should change the selection to the darker fill.
        d3.select(this).attr('fill', 'rgba(108, 122, 137, 0.5)');
        // Should keep fill if clicked and remove if not clicked.
        if (d3.select(this).classed('clicked')) {
          d3.select(this).classed('clicked', false);
        } else {
          d3.select(this).classed('clicked', true);
        }
        var x, y, k;
        if (d && centered !== d) {
          var centroid = path.centroid(d);
          x = centroid[0];
          y = centroid[1];
          k = 1.9;
          centered = d;
        } else {
          x = width / 3;
          y = height / 3;
          k = 1;
          centered = null;
        }

        map.selectAll('path')
          .classed('active', centered && function(d) {
            return d === centered;
          });

        map.transition()
          .duration(1000)
          .attr('transform', 'translate(' + width / 3 + ',' + height / 3 + ')scale(' + k + ')translate(' + -x + ',' + -y + ')')
          .style('stroke-width', 1 / k + 'px');

        // Transitions circles upon zoom.
        svg.selectAll('.bubble')
          .transition()
          .duration(1000)
          .attr('transform', 'translate(' + width / 3 + ',' + height / 3 + ')scale(' + k + ')translate(' + -x + ',' + -y + ')')
          .style('stroke-width', 1 / k + 'px');
      }

      d3.csv('https://raw.githubusercontent.com/dieterholger/US-Gun-Manufacturing-Interactive/master/top100cities.csv', function(error, data) {
        // Converts strings in csv to integers so they can be used.
        data.forEach(function(d) {
          return d.guns = +d.guns;
        })
        // This returns the max number of guns.
        var guns = data.map(function(d) {
          return d.guns;
        });

        var guns_extent = d3.extent(data, function(d) {
          return d.guns;
        });

        var radius = d3.scaleSqrt()
          .domain(guns_extent)
          .range([2, 40]);

        var bubbles = svg.append('g')
          .attr('class', 'bubble')
          .selectAll('circle')
          .data(data)
          .enter()
          .append('circle')
          .attr('cx', function(d) {
            return projection([d.lon, d.lat])[0];
          })
          .attr('cy', function(d) {
            return projection([d.lon, d.lat])[1];
          })

        // Separate out the animation and mouseover so the mousover works, per: https://stackoverflow.com/questions/22645162/d3-when-i-add-a-transition-my-mouseover-stops-working-why
        bubbles.attr('r', 0)
          .transition()
          .duration(1000)
          .attr('r', function(d) {
            return radius(d.guns);
          })
          .attr('fill', 'rgba(189, 189, 189, 0.5)')
          .attr('stroke', 'black');

        bubbles.on('mouseover', function(d) {
            tip.show(d);
            return d3.select(this).attr('fill', 'rgba(189, 189, 189, 0.9');
          })
          .on('mouseout', function(d) {
            tip.hide(d);
            return d3.select(this).attr('fill', 'rgba(189, 189, 189, 0.5)');
          });

        // Legend adapted from Mike Bostock's example here: https://bl.ocks.org/mbostock/9943478

        var legend = svg.append('g')
          .attr('class', 'legend')
          .attr('transform', 'translate(' + (width - 60) + ',' + (height - 10) + ')')
          .selectAll('g')
          .data([500000, 1000000, 2000000])
          .enter()
          .append('g');

        legend.append('circle')
          .attr('cy', function(d) {
            return -radius(d);
          })
          .attr('r', radius);

        legend.append('text')
          .attr('y', function(d) {
            return -1.9 * radius(d);
          })
          .attr('dy', '1.3em')
          .text(d3.format('.1s'));

      });
    };
  </script>
</head>

<body>
  <div id='map'>
    <h2>Hover your mouse to see data on the cities and click a state to zoom in.</h2>
  </div>
  <script>
    d3.json('https://raw.githubusercontent.com/dieterholger/US-Gun-Manufacturing-Interactive/master/us_states.json', draw);
  </script>
</body>
