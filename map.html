<!DOCTYPE html>
<html>

<head>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <meta charset='utf-8'>
  <meta name="viewport" content='width=device-width, initial-scale=1.0'>
  <title></title>
  <style>
    .tooltip {
      line-height: 1;
      font-weight: bold;
      padding: 12px;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      border-radius: 2px;
    }
  </style>
  <script>
    function draw(geo_data) {

      var margin = 20,
        width = 1500 - margin,
        height = 500 - margin;

      var svg = d3.select('#map')
        .append('svg')
        .attr('width', width + margin)
        .attr('height', height + margin)
        .append('g')
        .attr('class', 'map');

      var formatComma = d3.format(",")

      var projection = d3.geoAlbersUsa();

      var path = d3.geoPath().projection(projection);

      var map = svg.selectAll('path')
        .data(geo_data.features)
        .enter()
        .append('path')
        .attr('d', path)
        .style('fill', 'rgba(253, 227, 167, 0.8)')
        .style('stroke', 'black')
        .style('stroke-width', 0.5);

      var tooltip = svg.append('g')
        .attr('class', tooltip);

      tooltip.append('text')
        .attr('x', 15)
        .attr('dy', '1.2em')
        .style('font-size', '1.5em')
        .attr('font-weight', 'bold');

      d3.csv('https://raw.githubusercontent.com/dieterholger/US-Gun-Manufacturing-Interactive/master/top100cities.csv', function(error, data) {

        // Converts strings in csv to integers so they can be used.

        data.forEach(function(d) {
          return d.guns = +d.guns;
        })

        // This returns the max number of guns.

        var guns = data.map(function(d) {
          return d.guns
        });

        var radius = d3.scaleSqrt().domain([0, Math.max(...guns)]).range([0, 50]);

        svg.append('g')
          .attr('class', 'bubble')
          .selectAll('circle')
          .data(data)
          .enter()
          .append('circle')
          .attr('cx', function(d) {
            return projection([d.lon, d.lat])[0];
          })
          .attr('cy', function(d) {
            return projection([d.lon, d.lat])[1];
          })
          .attr('r', function(d) {
            return radius(d.guns);
          })
          .attr('fill', 'rgba(103, 65, 114, 0.5)')
          .attr('stroke', 'black')
          .on('mouseover', function(d) {
            return d3.select(this).attr('fill', 'rgba(103, 65, 114, 0.8)');
            tooltip.style('display', null);
            // textbox not working?
            //             var cityinfo = '<p>' + d.city + ', ' + d.state + '</p>'
            //             cityinfo += '<p><strong>' + formmatComma(d.guns) + 'guns</strong></p>'
            //
            //             d3.select('#textbox')
            //               .html('')
            //               .append('text')
            //               .html(string)
          })
          .on('mousemove', function(d) {
            var xPos = d3.mouse(this)[0] - 15;
            var yPos = d3.mouse(this)[1] - 55;
            tooltip.attr('transform', 'translate(' + xPos + ',' + yPos + ')');
            tooltip.select('text').text(d.city + ', ' + d.state + ': ' + formatComma(d.guns));
          })
          .on('mouseout', function(d) {
            return d3.select(this).attr('fill', 'rgba(103, 65, 114, 0.5)');
            tooltip.style('display', 'none');
          });

      });
    };
  </script>
</head>

<body>

  <div>
    <p>More than 30,000 guns were made every day in the USA in 2016, according to data the Bureau of Alcohol, Tobacco and Firearms (ATF) released this January. Gun makers made history and reported manufacturing nearly 11.5 million firearms, up from the previous
      record of 10.3 million in 2013.</p>

    <p>I extracted data from hundreds of PDFs the ATF published on gun manufacturing license holders to find out where these guns were being made and where people were making them. The top 100 cities for gun manufacturing mapped below accounted for 99 percent
      of all the guns manufactured in 2016.</p>

    <p>Hover your mouse to see data on the cities and click to zoom in.</p>
  </div>

  <div id='map'></div>
  <div>
    <p>Want to see the data yourself? You can download it here.</div>
  <script>
    d3.json('https://raw.githubusercontent.com/dieterholger/US-Gun-Manufacturing-Interactive/master/us_states.json', draw);
  </script>
</body>
