<!DOCTYPE html>
<html>

<head>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.7.1/d3-tip.js'></script>
  <meta charset='utf-8'>
  <meta name="viewport" content='width=device-width, initial-scale=1.0'>
  <title></title>
  <style>
    .d3-tip {
      line-height: 1;
      font-weight: bold;
      padding: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      border-radius: 10px;
    }

    .clicked {
      fill: rgba(108, 122, 137, 0.5);
    }

    body {
      background: rgba(32, 32, 32, 1);
      color: rgba(255, 255, 255, 0.8);
    }

    h1 {
      font-family: Impact, Charcoal, sans-serif;
      text-align: center;
      letter-spacing: 2px;
      font-size: 1.5rem;
    }

    h2 {
      font-family: Impact, Charcoal, sans-serif;
      text-align: center;
      letter-spacing: 2px;
      font-size: 1.25rem;
    }

    p {
      font-family: "Arial Black", Gadget, sans-serif;
      text-align: center;
      font-size: 0.9rem;
    }

    a {
      color: rgba(248, 148, 6, 0.9);
      text-decoration: none;
    }

    .explainer {
      padding: 8px;
    }

    #box {
      border: 10px solid rgba(0, 0, 0, 0.5);
      margin-left: auto;
      margin-right: auto;
      width: 95%;
      border-radius: 10px;
    }

    #map {
      width: 100%;
      padding: 10px;
      margin-left: auto;
      margin-right: auto;
    }
  </style>
  <script>
    function draw(geo_data) {

      var width = 960,
        height = 500

      var centered;

      var svg = d3.select('#map')
        .append('svg')
        .attr('width', width)
        .attr('height', height)
        .call(responsivefy)
        .append('g');

      var formatComma = d3.format(",");

      var projection = d3.geoAlbersUsa();

      var path = d3.geoPath().projection(projection);

      var map = svg.selectAll('path')
        .data(geo_data.features)
        .enter()
        .append('path')
        .attr('d', path)
        .attr('fill', 'rgba(105, 105, 105, 1)')
        .attr('stroke', 'rgba(0, 0, 0, 1)')
        .attr('stroke-width', 0.5)
        .on('mouseover', function(d) {
          d3.select(this).attr('fill', 'rgba(108, 122, 137, 0.5)')
        })
        .on('mouseout', function() {
          if (d3.select(this).classed('clicked')) {
            console.log('is clicked')
            d3.select(this).attr('fill', 'rgba(108, 122, 137, 0.5)')
          } else {
            console.log('is not clicked')
            d3.select(this).attr('fill', 'rgba(105, 105, 105, 1)')
          }
        })
        // Calls click-to-zoom function defined below.
        .on('click', clicked);


      var tip = d3.tip()
        .attr('class', 'd3-tip')
        .offset([-10, 0])
        .html(function(d) {
          return "<p><strong><font size='2rem'>" + d.city + ", " + d.state + "</p></strong></font>" + "<p><font size='2rem'><strong>Guns Manufactured: </strong>" + formatComma(d.guns) + "</p>" +
            "<p><strong>Top Manufacturer:</strong> " + d.manufacturer +
            "</p></font>";
        })

      svg.call(tip);

      // Responseify function found here: https://brendansudol.com/writing/responsive-d3

      function responsivefy(svg) {
        // get container + svg aspect ratio
        var container = d3.select(svg.node().parentNode),
          width = parseInt(svg.style('width')),
          height = parseInt(svg.style('height')),
          aspect = width / height;

        // add viewBox and preserveAspectRatio properties,
        // and call resize so that svg resizes on inital page load
        svg.attr('viewBox', "0 0 " + width + ' ' + height)
          .attr('perserveAspectRatio', 'xMinYMid')
          .call(resize);

        // to register multiple listeners for same event type,
        // you need to add namespace, i.e., 'click.foo'
        // necessary if you call invoke this function for multiple svgs
        // api docs: https://github.com/mbostock/d3/wiki/Selections#on
        d3.select(window).on("resize." + container.attr("id"), resize);

        // get width of container and resize svg to fit it
        function resize() {
          var targetWidth = parseInt(container.style("width"));
          svg.attr("width", targetWidth);
          svg.attr("height", Math.round(targetWidth / aspect));
        }
      }

      // Click-to-zoom function adapted from Mike Bostock's code: https://bl.ocks.org/mbostock/2206590

      function clicked(d) {
        // Should change the selection to the darker fill.
        d3.select(this).attr('fill', 'rgba(108, 122, 137, 0.5)');
        // Should keep fill if clicked and remove if not clicked.
        if (d3.select(this).classed('clicked')) {
          d3.select(this).classed('clicked', false);
        } else {
          d3.select(this).classed('clicked', true);
        }
        var x, y, k;
        if (d && centered !== d) {
          var centroid = path.centroid(d);
          x = centroid[0];
          y = centroid[1];
          k = 1.9;
          centered = d;
        } else {
          x = width / 3;
          y = height / 3;
          k = 1;
          centered = null;
        }

        map.selectAll('path')
          .classed('active', centered && function(d) {
            return d === centered;
          });

        map.transition()
          .duration(1000)
          .attr('transform', 'translate(' + width / 3 + ',' + height / 3 + ')scale(' + k + ')translate(' + -x + ',' + -y + ')')
          .style('stroke-width', 1 / k + 'px');

        // Transitions circles upon zoom.
        svg.selectAll('circle')
          .transition()
          .duration(1000)
          .attr('transform', 'translate(' + width / 3 + ',' + height / 3 + ')scale(' + k + ')translate(' + -x + ',' + -y + ')')
          .style('stroke-width', 1 / k + 'px');
      }

      d3.csv('https://raw.githubusercontent.com/dieterholger/US-Gun-Manufacturing-Interactive/master/top100cities.csv', function(error, data) {
        // Converts strings in csv to integers so they can be used.
        data.forEach(function(d) {
          return d.guns = +d.guns;
        })
        // This returns the max number of guns.
        var guns = data.map(function(d) {
          return d.guns;
        });
        var guns_extent = d3.extent(data, function(d) {
          return d.guns;
        });
        var radius = d3.scaleSqrt()
          .domain(guns_extent)
          .range([2, 40]);
        svg.append('g')
          .attr('class', 'bubble')
          .selectAll('circle')
          .data(data)
          .enter()
          .append('circle')
          .attr('cx', function(d) {
            return projection([d.lon, d.lat])[0];
          })
          .attr('cy', function(d) {
            return projection([d.lon, d.lat])[1];
          })
          .attr('r', function(d) {
            return radius(d.guns);
          })
          .attr('fill', 'rgba(248, 148, 6, 0.5)')
          .attr('stroke', 'black')
          .on('mouseover', function(d) {
            tip.show(d);
            return d3.select(this).attr('fill', 'rgba(248, 148, 6, 0.9)');
          })
          .on('mouseout', function(d) {
            tip.hide(d);
            return d3.select(this).attr('fill', 'rgba(248, 148, 6, 0.5)');
          })
      });
    };
  </script>
</head>

<body>

  <div id='box'>
    <h1>WHERE ARE GUNS IN AMERICA MADE AND WHO IS MAKING THEM?</h1>
    <p class='explainer'>American gun makers made history and reported manufacturing nearly 11.5 million firearms in 2016, up from the previous record of 10.3 million in 2013, according to data the Bureau of Alcohol, Tobacco and Firearms (ATF) released this January. That's
      the equivalent of more than 30,000 guns a day.</p>

    <p class='explainer'>I extracted data from hundreds of PDFs the ATF published on gun manufacturing license holders to find out where these guns were being made and who was making them.</p>

    <p class='explainer'>The top 100 cities for gun manufacturing mapped below account for 99 percent of all the guns manufactured in 2016. The top manufacturer listed for each city produced the highest share of firearms.</p>
  </div>


  <div id='map'>
    <h2>Hover your mouse to see data on the cities and click a state to zoom in.</h2>
  </div>
  <div id='box'>
    <p class='explainer'>The original source for the data was the <a href='https://www.atf.gov/about/docs/undefined/afmer2016webreport508pdf/download'>2016 ATF Annual Firearms Manufacturers and Export Report</a>. You can find my cleaned version of the data <a href='2016firearmmanufacturers.csv'>here</a>      and the csv used to make this map <a href='https://raw.githubusercontent.com/dieterholger/US-Gun-Manufacturing-Interactive/master/top100cities.csv'>here</a>.</p>
  </div>
  <script>
    d3.json('https://raw.githubusercontent.com/dieterholger/US-Gun-Manufacturing-Interactive/master/us_states.json', draw);
  </script>
</body>
