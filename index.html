<!DOCTYPE html>
<html>

<head>
  <script src='d3.min.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.7.1/d3-tip.js'></script>
  <script src='colorbrewer.v1.js'></script>
  <meta charset='utf-8'>
  <meta name="viewport" content='width=device-width, initial-scale=1.0'>
  <title></title>
  <style>
    .d3-tip {
      line-height: 1;
      padding: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      border-radius: 10px;
    }

    .clicked {
      fill: rgba(108, 122, 137, 0.5);
    }

    body {
      background: rgba(32, 32, 32, 1);
      color: rgba(255, 255, 255, 0.8);
    }

    h1 {
      font-family: Impact, Charcoal, sans-serif;
      text-align: center;
      letter-spacing: 2px;
      font-size: 1.5rem;
    }

    h2 {
      font-family: Impact, Charcoal, sans-serif;
      text-align: center;
      letter-spacing: 2px;
      font-size: 1.25rem;
    }

    p {
      font-family: "Arial Black", Gadget, sans-serif;
      text-align: center;
      font-size: 0.9rem;
    }

    a {
      color: rgba(248, 148, 6, 0.9);
      text-decoration: none;
    }

    .explainer {
      padding: 8px;
    }

    .box {
      border: 10px solid rgba(0, 0, 0, 0.5);
      margin-left: auto;
      margin-right: auto;
      width: 95%;
      border-radius: 10px;
    }

    #map {
      width: 100%;
      padding: 10px;
      margin-left: auto;
      margin-right: auto;
    }

    #stackedBar {
      width: 100%;
      padding: 10px;
      margin-left: auto;
      margin-right: auto;
    }

    .legend circle {
      fill: rgba(248, 148, 6, 0.1);
      stroke: black;
    }

    .legend text {
      fill: rgba(255, 255, 255, 1);
      font-family: "Arial Black", Gadget, sans-serif;
      text-anchor: middle;
      font-size: 0.4rem;
    }

    /* Settings for axes. */

    .axis path,
    .axis line {
      fill: none;
      stroke: rgba(255, 255, 255, 0.8);
      stroke-width: 1px;
      shape-rendering: crispEdges;
    }

    .axis text {
      font-family: "Arial Black", Gadget, sans-serif;
      font-size: 0.6rem;
      fill: rgba(255, 255, 255, 0.8);
    }
  </style>
  <script>
    function drawMap(geo_data) {

      var width = 960,
        height = 500

      var centered;

      var svg = d3.select('#map')
        .append('svg')
        .attr('width', width)
        .attr('height', height)
        .call(responsivefy)
        .append('g');

      var formatComma = d3.format(",");

      var projection = d3.geoAlbersUsa();

      var path = d3.geoPath().projection(projection);

      var map = svg.selectAll('path')
        .data(geo_data.features)
        .enter()
        .append('path')
        .attr('d', path)
        .attr('fill', 'rgba(105, 105, 105, 1)')
        .attr('stroke', 'rgba(0, 0, 0, 1)')
        .attr('stroke-width', 0.5)
        .on('mouseover', function(d) {
          d3.select(this).attr('fill', 'rgba(108, 122, 137, 0.5)')
        })
        .on('mouseout', function() {
          if (d3.select(this).classed('clicked')) {
            console.log('is clicked')
            d3.select(this).attr('fill', 'rgba(108, 122, 137, 0.5)')
          } else {
            console.log('is not clicked')
            d3.select(this).attr('fill', 'rgba(105, 105, 105, 1)')
          }
        })
        // Calls click-to-zoom function defined below.
        .on('click', clicked);

      // Settings for tooltip text and content.

      var tip = d3.tip()
        .attr('class', 'd3-tip')
        .offset([-10, 0])
        .html(function(d) {
          return "<p><strong><font size='3rem'>" + d.city + ", " + d.state + "</p></strong></font>" + "<p><font size='2rem'><strong>Guns Manufactured: </strong>" + formatComma(d.guns) + "</p>" +
            "<p><strong>Top Manufacturer:</strong> " + d.manufacturer +
            "</p></font>";
        })

      svg.call(tip);

      // Responseify function found here: https://brendansudol.com/writing/responsive-d3

      function responsivefy(svg) {
        // get container + svg aspect ratio
        var container = d3.select(svg.node().parentNode),
          width = parseInt(svg.style('width')),
          height = parseInt(svg.style('height')),
          aspect = width / height;

        // add viewBox and preserveAspectRatio properties,
        // and call resize so that svg resizes on inital page load
        svg.attr('viewBox', "0 0 " + width + ' ' + height)
          .attr('perserveAspectRatio', 'xMinYMid')
          .call(resize);

        // to register multiple listeners for same event type,
        // you need to add namespace, i.e., 'click.foo'
        // necessary if you call invoke this function for multiple svgs
        // api docs: https://github.com/mbostock/d3/wiki/Selections#on
        d3.select(window).on("resize." + container.attr("id"), resize);

        // get width of container and resize svg to fit it
        function resize() {
          var targetWidth = parseInt(container.style("width"));
          svg.attr("width", targetWidth);
          svg.attr("height", Math.round(targetWidth / aspect));
        }
      }

      // Click-to-zoom function adapted from Mike Bostock's code: https://bl.ocks.org/mbostock/2206590

      function clicked(d) {
        // Should change the selection to the darker fill.
        d3.select(this).attr('fill', 'rgba(108, 122, 137, 0.5)');
        // Should keep fill if clicked and remove if not clicked.
        if (d3.select(this).classed('clicked')) {
          d3.select(this).classed('clicked', false);
        } else {
          d3.select(this).classed('clicked', true);
        }
        var x, y, k;
        if (d && centered !== d) {
          var centroid = path.centroid(d);
          x = centroid[0];
          y = centroid[1];
          k = 1.9;
          centered = d;
        } else {
          x = width / 3;
          y = height / 3;
          k = 1;
          centered = null;
        }

        map.selectAll('path')
          .classed('active', centered && function(d) {
            return d === centered;
          });

        map.transition()
          .duration(1000)
          .attr('transform', 'translate(' + width / 3 + ',' + height / 3 + ')scale(' + k + ')translate(' + -x + ',' + -y + ')')
          .style('stroke-width', 1 / k + 'px');

        // Transitions all bubbles on map upon zoom, don't select all circles as this will zoom the legend.

        svg.selectAll('.bubble')
          .transition()
          .duration(1000)
          .attr('transform', 'translate(' + width / 3 + ',' + height / 3 + ')scale(' + k + ')translate(' + -x + ',' + -y + ')')
          .style('stroke-width', 1 / k + 'px');
      }

      d3.csv('https://raw.githubusercontent.com/dieterholger/US-Gun-Manufacturing-Interactive/master/top100cities.csv', function(error, data) {
        // Converts strings in csv to integers so they can be used.
        data.forEach(function(d) {
          return d.guns = +d.guns;
        })
        // This returns the max number of guns.
        var guns = data.map(function(d) {
          return d.guns;
        });

        var guns_extent = d3.extent(data, function(d) {
          return d.guns;
        });

        var radius = d3.scaleSqrt()
          .domain(guns_extent)
          .range([2, 40]);

        var bubbles = svg.append('g')
          .attr('class', 'bubble')
          .selectAll('circle')
          .data(data)
          .enter()
          .append('circle')
          .attr('cx', function(d) {
            return projection([d.lon, d.lat])[0];
          })
          .attr('cy', function(d) {
            return projection([d.lon, d.lat])[1];
          })

        // Separate out the animation and mouseover so the mousover works, per: https://stackoverflow.com/questions/22645162/d3-when-i-add-a-transition-my-mouseover-stops-working-why
        var bubblesAnimation = bubbles.attr('r', 0)
          .transition()
          .duration(1000)
          .attr('r', function(d) {
            return radius(d.guns);
          })
          .attr('fill', 'rgba(248, 148, 6, 0.5)')
          .attr('stroke', 'black');

        var bubblesMouseover = bubbles.on('mouseover', function(d) {
            tip.show(d);
            return d3.select(this).attr('fill', 'rgba(248, 148, 6, 0.9)');
          })
          .on('mouseout', function(d) {
            tip.hide(d);
            return d3.select(this).attr('fill', 'rgba(248, 148, 6, 0.5)');
          });

        // Legend adapted from Mike Bostock's example here: https://bl.ocks.org/mbostock/9943478

        var legend = svg.append('g')
          .attr('class', 'legend')
          .attr('transform', 'translate(' + (width - 60) + ',' + (height - 10) + ')')
          .selectAll('g')
          .data([500000, 1000000, 2000000])
          .enter()
          .append('g');

        legend.append('text')
          .attr('y', function(d) {
            return -1.9 * radius(d);
          })
          .attr('dy', '1.3em')
          .text(d3.format('.1s'));

        legend.append('circle')
          .attr('cy', function(d) {
            return -radius(d);
          })
          .attr('r', radius);
      });
    };

    // Stacked bar function.

    function drawStackedBar(data) {

      // Turns all the strings in the csv into integer values.

      data.forEach(function(d) {
        d.Rifles = +d.Rifles;
        d.Pistols = +d.Pistols;
        d.Shotguns = +d.Shotguns;
        d.Revolvers = +d.Revolvers;
        d.Misc = +d.Misc;
        d.Total = +d.Total;
      });

      // var width = document.getElementById('stackedBar').offsetWidth,
      //   height = document.getElementById('stackedBar').offsetHeight;

      var width = 960,
        height = 500

      var margin = {
        top: 20,
        right: 120,
        bottom: 30,
        left: 50
      };

      var svg = d3.select('#stackedBar')
        .append('svg')
        .attr('width', '100%')
        .attr('height', '100%')
        .attr('viewBox', '0 0 ' + width + ' ' + height)
        .append('g');

      width = width - margin.left - margin.right,
        height = height - margin.top - margin.bottom;

      svg.attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

      var xScale = d3.scaleBand()
        .range([0, width])
        .padding(0.4);

      var yScale = d3.scaleLinear()
        .range([height, 0]);

      xScale.domain(data.map(function(d) {
        return d.Year;
      }));

      yScale.domain([0, d3.max(data, function(d) {
        return d.Total;
      })]);

      var x_axis = svg.append('g')
        .attr('class', 'axis')
        .attr('padding', 1)
        .attr('transform', 'translate(' + 0 + ',' + height + ')')
        .call(d3.axisBottom(xScale))
        .selectAll('text')
        .style('text-anchor', 'end')
        .attr('transform', 'rotate(-40)')

      // Now append fthe y_axis to the svg by calling the scale. 'S' sets the tick format to standard.

      var y_axis = svg.append('g')
        .attr('class', 'axis')
        .call(d3.axisLeft(yScale)
          .ticks(10, 's'));

      // Choose which columns to have as keys with the slice method.

      var keys = data.columns.slice(1, -1);

      // Create a stack of the data based on the keys.

      var stack = d3.stack(data)
        .keys(keys);

      // Create a series of the data.

      var series = stack(data);

      // Create color scale or pass in array of colors.

      var colorScale = d3.scaleOrdinal()
        .domain([0, 5])
        .range(colorbrewer.Oranges[5]);

      // Create the variable and then append a group element.
      var bars = svg.append('g')
        // Select all the group elements.
        .selectAll('g')
        .data(series)
        .enter()
        // Append a new group element in this order, so the rectangles are in group element.
        // Each g here represents each of the keys of the data, in this case each firearm type.
        .append('g')
        // Set the color scale after creating the group for each of the keys, or the weapons in this case.
        .attr('fill', function(d) {
          return colorScale(d.key);
        })
        // When you select the rectangle it doesn't exist yet, because you haven't appended it yet.
        // But only after adding the data do you append the rectangle inside your svg.
        .selectAll('rect')
        // Call the data again and return it. Everytime you append something new you need to show what data you're using.
        .data(function(d) {
          return d;
        })
        // So you need enter the data and append the rectangles that were previously selected.
        .enter()
        .append('rect')
        // Here you set the x and y.
        // You need to use d.Data.Year to select only the year value inside the data array.
        .attr('x', function(d) {
          return xScale(d.data.Year);
        })
        // Now you need to set the y. You need to set the index to 1, which is the index that contains the data in the array.
        .attr('y', function(d) {
          return yScale(d[1]);
        });

      // Separate animation and mouseover so mousover doesn't break, per: https://stackoverflow.com/questions/22645162/d3-when-i-add-a-transition-my-mouseover-stops-working-why
      bars.attr('height', 0)
        .transition()
        .duration(1000)
        // Sets the animation delay between each column.
        .delay(function(d, i) {
          return i * 20;
        })
        // Set the width and height of the bars how they are located.
        .attr('width', xScale.bandwidth())
        // So now set the y value by the arrays.
        .attr('height', function(d) {
          return yScale(d[0]) - yScale(d[1]);
        });

      // Sets mousover and mouseout events.
      bars.on('mouseover', function(d) {
          tip.show(d);
        })
        .on('mouseout', function(d) {
          tip.hide(d);
        });

      // Settings for the tooltip.

      var tip = d3.tip()
        .attr('class', 'd3-tip')
        .offset([-10, 0])
        .html(function(d) {
          return "<p><font size='3rem'>" + d.data.Year + "</p></font><p><font size='2rem'>Misc: " + formatComma(d.data.Misc) + "</p><p>Revolvers: " + formatComma(d.data.Revolvers) + "</p><p>Shotguns: " + formatComma(d.data.Shotguns) +
            "</p><p>Pistols: " +
            formatComma(d.data.Pistols) + "</p><p>Rifles: " + formatComma(d.data.Rifles) + "</p></font>";
        })

      svg.call(tip);

      // Formats numbers with commas for display in the tooltip.

      var formatComma = d3.format(",");

      // Settings for the legend.

      var legendRectSize = 18;
      var legendSpacing = 4;

      var stackedBarLegend = svg.selectAll('.stackedBarLegend')
        // Sets the data to the keys and reverses their order so they appear correctly.
        .data(keys.reverse())
        .enter()
        .append('g')
        .attr('transform', function(d, i) {
          // Modify vert and horzontal variables by adding or subracting pixels to change its position.
          var height = legendRectSize + legendSpacing;
          var offset = height * colorScale.length / 2;
          var horz = width + 15;
          var vert = i * height - offset;
          return 'translate(' + horz + ',' + vert + ')';
        });

      stackedBarLegend.append('rect')
        .attr('width', legendRectSize)
        .attr('height', legendRectSize)
        .style('fill', colorScale)
        .style('stroke', colorScale);

      stackedBarLegend.append('text')
        .attr('x', legendRectSize + legendSpacing)
        .attr('y', legendRectSize - legendSpacing)
        .attr('fill', 'rgba(255, 255, 255, 0.8)')
        .text(function(d, i) {
          return keys[i];
        })

      console.log(data);

      console.log(keys);

      console.log(series);
    };
  </script>
</head>

<body>

  <div class='box'>
    <h1>WHERE ARE GUNS IN AMERICA MADE AND WHO IS MAKING THEM?</h1>
    <p class='explainer'>American gun makers made history and reported manufacturing nearly 11.5 million firearms in 2016, up from the previous record of 10.3 million in 2013, according to data the Bureau of Alcohol, Tobacco, Firearms and Explosives (ATF) released this January.
      That's the equivalent of more than 30,000 guns a day. These firearms are broken into five categories: pistols, revolvers, shotguns, rifles and miscellaneous.</p>

    <p class='explainer'>I extracted data from hundreds of PDFs the ATF published on gun manufacturing license holders to find out where these guns were being made and who was making them.</p>

    <p class='explainer'>The top 100 cities for gun manufacturing mapped below account for 99 percent of all the guns manufactured in 2016. The top manufacturer listed for each city produced the highest share of firearms.</p>
  </div>

  <div id='map'>
    <h2>Hover your mouse to see data on the cities and click a state to zoom in.</h2>
  </div>

  <div class='box'>
    <h1>AMERICAN GUN MANUFACTURING ON THE RISE</h1>
    <p class='explainer'>Gun manufacturing has seen a spike in the last three reported years from the previous 10 years. 2.1 million more firearms were produced in 2016 from the previous year, totaling more than 11 million to become the largest amount in reported history.
      In 2013, now the second highest year, more than 10.3 million guns were made.</p>
  </div>

  <div id='stackedBar'>
    <h2>Hover your mouse to see the amount of guns manufactured by year.<h2>
  </div>
  <div class='box'>
    <p class='explainer'>The original source for the data was the <a href='https://www.atf.gov/about/docs/undefined/afmer2016webreport508pdf/download'>2016 ATF Annual Firearms Manufacturers and Export Report</a>. You can find my cleaned version of the data <a href='2016firearmmanufacturers.csv'>here</a>      and the csv used to make this map <a href='https://raw.githubusercontent.com/dieterholger/US-Gun-Manufacturing-Interactive/master/top100cities.csv'>here</a>.</p>
  </div>
  <script>
    d3.json('https://raw.githubusercontent.com/dieterholger/US-Gun-Manufacturing-Interactive/master/us_states.json', drawMap);
    d3.csv('https://raw.githubusercontent.com/dieterholger/US-Gun-Manufacturing-Interactive/master/yearlymanufacturing.csv', drawStackedBar);
  </script>
</body>
